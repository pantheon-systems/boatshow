'use strict';

function onYouTubeIframeAPIReady() {
  Drupal.behaviors.videoModal.InitializeViewModel();
}

(function ($, Drupal) {
  Drupal.behaviors.videoModal = {
    attach: function attach(context, settings) {
      $('.js-video-modal').on('click', function (e) {
        e.preventDefault();
        Drupal.behaviors.videoModal.openVideoModal($(this));
      });
    },

    viewModel: {},

    clickedElement: {},

    openVideoModal: function openVideoModal(el) {
      Drupal.behaviors.videoModal.clickedElement = el;

      if (typeof YT === "undefined") {
        $.getScript('//www.youtube.com/player_api');
      } else {
        Drupal.behaviors.videoModal.InitializeViewModel();
      }
    },

    InitializeViewModel: function InitializeViewModel() {
      Drupal.behaviors.videoModal.clickedElement.openModal({
        templateId: 'video-template',
        width: 'auto'
      });

      var videoId = Drupal.behaviors.videoModal.clickedElement.data("videoid");
      var trackingEnabled = Drupal.behaviors.videoModal.clickedElement.data("videotracking") && Drupal.behaviors.videoModal.clickedElement.data("videotracking") === true;

      Drupal.behaviors.videoModal.viewModel = new Drupal.behaviors.videoModal.videoViewModel(videoId, trackingEnabled);

      var koEle = document.getElementById('modal-video');
      ko.cleanNode(koEle);
      ko.applyBindings(Drupal.behaviors.videoModal.viewModel, koEle);
      $('.video-holder').fitVids();
    },

    videoViewModel: function videoViewModel(videoId, trackingEnabled) {
      var self = this;
      self.intervalId = null;
      self.TrackingEnabled = ko.observable(trackingEnabled);
      self.VideoId = ko.observable(videoId);
      self.VideoTitle = ko.observable();
      self.VideoLink = ko.computed(function () {
        return "http://www.youtube.com/watch?v=" + self.VideoId();
      });

      self.Player = new YT.Player('video-iframe', {
        playerVars: { autoplay: 1, controls: 0, showinfo: 1, rel: 0, modestbranding: 1 },
        videoId: videoId,
        events: {
          'onReady': Drupal.behaviors.videoModal.PlayerReady,
          'onStateChange': Drupal.behaviors.videoModal.PlayerStateChange
        }
      });

      self.PlayerState = ko.observable();

      self.FormatNumberLength = function (num, length) {
        var r = "" + num;
        while (r.length < length) {
          r = "0" + r;
        }
        return r;
      };

      self.ConvertSecondsToTimeStamp = function (seconds) {
        if (typeof seconds === 'undefined' || seconds < 1) {
          return "";
        }

        var minutes = Math.floor(seconds / 60);
        var leftSeconds = (seconds - minutes * 60).toFixed(0);
        leftSeconds = self.FormatNumberLength(leftSeconds, 2);

        return minutes + ":" + leftSeconds;
      };

      self.TotalLength = ko.observable(0);

      self.TotalLengthLabel = ko.computed(function () {
        return self.ConvertSecondsToTimeStamp(self.TotalLength());
      }, self);

      self.CurrentTime = ko.observable(0);

      self.CurrentTimeLabel = ko.computed(function () {
        return self.ConvertSecondsToTimeStamp(self.CurrentTime());
      }, self);

      self.ProgressPercent = function (current, total) {
        var percent = 0;

        if (current == 0 || total == 0) {
          return percent;
        }

        if (current >= total) {
          percent = 100;
          return percent;
        }

        percent = current / total * 100;

        return percent;
      };

      self.CurrentTimeProgressStyle = ko.computed(function () {
        var style = "width:" + self.ProgressPercent(self.CurrentTime(), self.TotalLength()) + "%;";
        return style;
      }, self);

      self.IsPlaying = ko.observable(!self.isTouchDevice);

      self.PauseClass = ko.computed(function () {
        return self.IsPlaying() ? "pause" : "";
      }, self);

      self.TriggerPlayPause = function () {
        if (self.IsPlaying()) {
          self.Player.pauseVideo();
        } else {
          self.Player.playVideo();
        }
      };

      self.TriggerPause = function () {
        if (self.IsPlaying()) {
          self.Player.pauseVideo();
        }

        return true;
      };

      // Progress
      self.IsProgressDrag = ko.observable(false);

      self.TriggerProgress = function (data, e) {
        var position = e.pageX,
            touch;

        if (self.isTouchDevice) {
          if (e.originalEvent.targetTouches !== undefined) {
            touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
            position = touch.pageX;
          } else {
            return;
          }
        }

        self.IsProgressDrag(true);
        self.UpdateProgress(position);
      };

      self.UpdateProgress = function (xPosition) {
        var videoProgressTotal = $('#video-progress-total'),
            position = xPosition - videoProgressTotal.offset().left,
            percentage = 100 * (position / videoProgressTotal.width());

        if (percentage > 100) {
          percentage = 100;
        }

        if (percentage < 0) {
          percentage = 0;
        }

        self.Player.seekTo(self.TotalLength() * percentage / 100);
      };

      self.BindProgressEvents = function () {
        $(document).on('mouseup', function (e) {
          if (self.IsProgressDrag()) {
            self.IsProgressDrag(false);
            self.UpdateProgress(e.pageX);
          }
        });

        $(document).on('mousemove', function (e) {
          if (self.IsProgressDrag()) {
            self.UpdateProgress(e.pageX);
          }
        });
      };

      // Volume
      self.IsVolumeDrag = ko.observable(false);

      self.TriggerVolume = function (data, e) {
        var position = e.pageX,
            touch;

        if (self.isTouchDevice) {
          if (e.originalEvent.targetTouches !== undefined) {
            touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
            position = touch.pageX;
          } else {
            return;
          }
        }

        self.IsVolumeDrag(true);
        e.preventDefault();
        self.UpdateVolume(position);
      };

      self.UpdateVolume = function (xPosition) {
        var videoVolumeTotal = $('#video-volume-total'),
            videoVolumeCurrent = $('#video-volume-current'),
            position = xPosition - videoVolumeTotal.offset().left,
            percentage = 100 * (position / videoVolumeTotal.width());

        if (percentage > 100) {
          percentage = 100;
        }
        if (percentage < 0) {
          percentage = 0;
        }

        videoVolumeCurrent.css('width', percentage + '%');
        self.Player.setVolume(percentage);
      };

      self.BindVolumeEvents = function () {
        $(document).on('mouseup', function (e) {
          if (self.IsVolumeDrag()) {
            self.IsVolumeDrag(false);
            self.UpdateVolume(e.pageX);
          }
        });

        $(document).on('mousemove', function (e) {
          if (self.IsVolumeDrag()) {
            self.UpdateVolume(e.pageX);
          }
        });
      };

      // Fullscreen
      self.IsFullScreen = ko.observable(false);
      self.FullScreenClass = ko.computed(function () {
        return self.IsFullScreen() ? 'is-fullscreen' : '';
      });

      self.TriggerFullScreen = function () {
        self.IsFullScreen(!self.IsFullScreen());
      };

      // State
      self.PlayerStateChange = function (state) {
        self.PlayerState(state);

        if (state.data == YT.PlayerState.PLAYING && !self.IsPlaying()) {
          self.IsPlaying(true);
        }

        if (state.data == YT.PlayerState.PAUSED && self.IsPlaying()) {
          self.IsPlaying(false);
        }

        if (state.data == YT.PlayerState.ENDED) {
          self.IsPlaying(false);
        }

        if (self.TrackingEnabled() === true) {
          self.GATracking(state.data);
        }
      };

      self.PlayerReady = function () {
        self.TotalLength(self.Player.getDuration());
        self.VideoTitle(self.Player.getVideoData().title);
        self.Player.setVolume(80);
        self.StartInterval();
        self.BindVolumeEvents();
        self.BindProgressEvents();
      };

      self.UpdateInterval = ko.observable();

      self.StartInterval = function () {
        self.UpdateInterval = setInterval(self.UpdateUI, 100);
      };

      self.StopInterval = function () {
        clearInterval(self.UpdateInterval);
      };

      self.UpdateUI = function () {
        self.CurrentTime(self.Player.getCurrentTime());

        if (self.TotalLength() == 0) {
          self.TotalLength(self.Player.getDuration());
        }
      };

      // --------------------------------------
      // -------   GA tracking  ---------------
      //---------------------------------------

      self.GATracking = function (state) {
        var key = self.VideoId();
        switch (state) {
          case YT.PlayerState.PLAYING:
            ga('send', 'event', key + ' - video', 'Started', key + ' - video tracking');
            dataLayer.push({ 'event': 'started' });
            self.GAStartPlayTracking(key);
            break;
          case YT.PlayerState.ENDED:
            self.GAStopPlayTracking();
            ga('send', 'event', key + ' - video', 'Completed', key + ' - video tracking');
            dataLayer.push({ 'event': 'completed' });
            break;
        }
      };

      self.GAStartPlayTracking = function (key) {
        self.GAStopPlayTracking();

        var intervalTime = 5,
            intervalCount = 4,
            intervalRatio = 1 / 4,
            intervalMarkers = [intervalCount],
            duration = self.Player.getDuration();

        intervalMarkers[0] = 0;

        for (var i = 1; i < intervalCount; i++) {
          intervalMarkers[i] = i * intervalRatio * duration;
        }

        self.intervalId = setInterval(function () {
          var time = self.Player.getCurrentTime();

          $.each(intervalMarkers, function (index, item) {
            if (item - time < intervalTime && item - time > 0) {
              var percent = intervalRatio * index * 100 + '%',
                  percentNum = intervalRatio * index * 100;
              ga('send', 'event', key + ' - video', 'Watched ' + percent, key + ' - video tracking');
              dataLayer.push({ 'event': 'watched' + percentNum });
              intervalMarkers[index] = 0;
            }
          });
        }, intervalTime * 1000);
      };

      self.GAStopPlayTracking = function () {
        if (self.intervalId != undefined) {
          clearInterval(self.intervalId);
        }
      };
      return self;
    },

    isTouchDevice: function isTouchDevice() {
      return 'ontouchstart' in window || navigator.MaxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    },

    PlayerReady: function PlayerReady(key) {
      Drupal.behaviors.videoModal.viewModel.PlayerReady();
    },

    PlayerStateChange: function PlayerStateChange(state) {
      Drupal.behaviors.videoModal.viewModel.PlayerStateChange(state);
    }

  };
})(jQuery, Drupal);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjQtb3JnYW5pc21zL3ZpZGVvcy5qcyJdLCJuYW1lcyI6WyJvbllvdVR1YmVJZnJhbWVBUElSZWFkeSIsIkRydXBhbCIsImJlaGF2aW9ycyIsInZpZGVvTW9kYWwiLCJJbml0aWFsaXplVmlld01vZGVsIiwiJCIsImF0dGFjaCIsImNvbnRleHQiLCJzZXR0aW5ncyIsIm9uIiwiZSIsInByZXZlbnREZWZhdWx0Iiwib3BlblZpZGVvTW9kYWwiLCJ2aWV3TW9kZWwiLCJjbGlja2VkRWxlbWVudCIsImVsIiwiWVQiLCJnZXRTY3JpcHQiLCJvcGVuTW9kYWwiLCJ0ZW1wbGF0ZUlkIiwid2lkdGgiLCJ2aWRlb0lkIiwiZGF0YSIsInRyYWNraW5nRW5hYmxlZCIsInZpZGVvVmlld01vZGVsIiwia29FbGUiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwia28iLCJjbGVhbk5vZGUiLCJhcHBseUJpbmRpbmdzIiwiZml0VmlkcyIsInNlbGYiLCJpbnRlcnZhbElkIiwiVHJhY2tpbmdFbmFibGVkIiwib2JzZXJ2YWJsZSIsIlZpZGVvSWQiLCJWaWRlb1RpdGxlIiwiVmlkZW9MaW5rIiwiY29tcHV0ZWQiLCJQbGF5ZXIiLCJwbGF5ZXJWYXJzIiwiYXV0b3BsYXkiLCJjb250cm9scyIsInNob3dpbmZvIiwicmVsIiwibW9kZXN0YnJhbmRpbmciLCJldmVudHMiLCJQbGF5ZXJSZWFkeSIsIlBsYXllclN0YXRlQ2hhbmdlIiwiUGxheWVyU3RhdGUiLCJGb3JtYXROdW1iZXJMZW5ndGgiLCJudW0iLCJsZW5ndGgiLCJyIiwiQ29udmVydFNlY29uZHNUb1RpbWVTdGFtcCIsInNlY29uZHMiLCJtaW51dGVzIiwiTWF0aCIsImZsb29yIiwibGVmdFNlY29uZHMiLCJ0b0ZpeGVkIiwiVG90YWxMZW5ndGgiLCJUb3RhbExlbmd0aExhYmVsIiwiQ3VycmVudFRpbWUiLCJDdXJyZW50VGltZUxhYmVsIiwiUHJvZ3Jlc3NQZXJjZW50IiwiY3VycmVudCIsInRvdGFsIiwicGVyY2VudCIsIkN1cnJlbnRUaW1lUHJvZ3Jlc3NTdHlsZSIsInN0eWxlIiwiSXNQbGF5aW5nIiwiaXNUb3VjaERldmljZSIsIlBhdXNlQ2xhc3MiLCJUcmlnZ2VyUGxheVBhdXNlIiwicGF1c2VWaWRlbyIsInBsYXlWaWRlbyIsIlRyaWdnZXJQYXVzZSIsIklzUHJvZ3Jlc3NEcmFnIiwiVHJpZ2dlclByb2dyZXNzIiwicG9zaXRpb24iLCJwYWdlWCIsInRvdWNoIiwib3JpZ2luYWxFdmVudCIsInRhcmdldFRvdWNoZXMiLCJ1bmRlZmluZWQiLCJ0b3VjaGVzIiwiY2hhbmdlZFRvdWNoZXMiLCJVcGRhdGVQcm9ncmVzcyIsInhQb3NpdGlvbiIsInZpZGVvUHJvZ3Jlc3NUb3RhbCIsIm9mZnNldCIsImxlZnQiLCJwZXJjZW50YWdlIiwic2Vla1RvIiwiQmluZFByb2dyZXNzRXZlbnRzIiwiSXNWb2x1bWVEcmFnIiwiVHJpZ2dlclZvbHVtZSIsIlVwZGF0ZVZvbHVtZSIsInZpZGVvVm9sdW1lVG90YWwiLCJ2aWRlb1ZvbHVtZUN1cnJlbnQiLCJjc3MiLCJzZXRWb2x1bWUiLCJCaW5kVm9sdW1lRXZlbnRzIiwiSXNGdWxsU2NyZWVuIiwiRnVsbFNjcmVlbkNsYXNzIiwiVHJpZ2dlckZ1bGxTY3JlZW4iLCJzdGF0ZSIsIlBMQVlJTkciLCJQQVVTRUQiLCJFTkRFRCIsIkdBVHJhY2tpbmciLCJnZXREdXJhdGlvbiIsImdldFZpZGVvRGF0YSIsInRpdGxlIiwiU3RhcnRJbnRlcnZhbCIsIlVwZGF0ZUludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJVcGRhdGVVSSIsIlN0b3BJbnRlcnZhbCIsImNsZWFySW50ZXJ2YWwiLCJnZXRDdXJyZW50VGltZSIsImtleSIsImdhIiwiZGF0YUxheWVyIiwicHVzaCIsIkdBU3RhcnRQbGF5VHJhY2tpbmciLCJHQVN0b3BQbGF5VHJhY2tpbmciLCJpbnRlcnZhbFRpbWUiLCJpbnRlcnZhbENvdW50IiwiaW50ZXJ2YWxSYXRpbyIsImludGVydmFsTWFya2VycyIsImR1cmF0aW9uIiwiaSIsInRpbWUiLCJlYWNoIiwiaW5kZXgiLCJpdGVtIiwicGVyY2VudE51bSIsIndpbmRvdyIsIm5hdmlnYXRvciIsIk1heFRvdWNoUG9pbnRzIiwibXNNYXhUb3VjaFBvaW50cyIsImpRdWVyeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxTQUFTQSx1QkFBVCxHQUFtQztBQUNqQ0MsU0FBT0MsU0FBUCxDQUFpQkMsVUFBakIsQ0FBNEJDLG1CQUE1QjtBQUNEOztBQUVELENBQUMsVUFBVUMsQ0FBVixFQUFhSixNQUFiLEVBQXFCO0FBQ3BCQSxTQUFPQyxTQUFQLENBQWlCQyxVQUFqQixHQUE4QjtBQUM1QkcsWUFBUSxTQUFTQSxNQUFULENBQWdCQyxPQUFoQixFQUF5QkMsUUFBekIsRUFBbUM7QUFDekNILFFBQUUsaUJBQUYsRUFBcUJJLEVBQXJCLENBQXdCLE9BQXhCLEVBQWlDLFVBQVVDLENBQVYsRUFBYTtBQUM1Q0EsVUFBRUMsY0FBRjtBQUNBVixlQUFPQyxTQUFQLENBQWlCQyxVQUFqQixDQUE0QlMsY0FBNUIsQ0FBMkNQLEVBQUUsSUFBRixDQUEzQztBQUNELE9BSEQ7QUFJRCxLQU4yQjs7QUFRNUJRLGVBQVcsRUFSaUI7O0FBVTVCQyxvQkFBZ0IsRUFWWTs7QUFZNUJGLG9CQUFnQix3QkFBVUcsRUFBVixFQUFjO0FBQzVCZCxhQUFPQyxTQUFQLENBQWlCQyxVQUFqQixDQUE0QlcsY0FBNUIsR0FBNkNDLEVBQTdDOztBQUVBLFVBQUksT0FBT0MsRUFBUCxLQUFjLFdBQWxCLEVBQStCO0FBQzdCWCxVQUFFWSxTQUFGLENBQVksOEJBQVo7QUFDRCxPQUZELE1BRU87QUFDTGhCLGVBQU9DLFNBQVAsQ0FBaUJDLFVBQWpCLENBQTRCQyxtQkFBNUI7QUFDRDtBQUNGLEtBcEIyQjs7QUFzQjVCQSx5QkFBcUIsK0JBQVk7QUFDL0JILGFBQU9DLFNBQVAsQ0FBaUJDLFVBQWpCLENBQTRCVyxjQUE1QixDQUEyQ0ksU0FBM0MsQ0FBcUQ7QUFDbkRDLG9CQUFZLGdCQUR1QztBQUVuREMsZUFBTztBQUY0QyxPQUFyRDs7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OztBQWdYNUJDLHVCQUFtQiwyQkFBVTJELEtBQVYsRUFBaUI7QUFDbEMzRyxhQUFPQyxTQUFQLENBQWlCQyxVQUFqQixDQUE0QlUsU0FBNUIsQ0FBc0NvQyxpQkFBdEMsQ0FBd0QyRCxLQUF4RDtBQUNEOztBQWxYMkIsR0FBOUI7QUFxWEQsQ0F0WEQsRUFzWEdvQyxNQXRYSCxFQXNYVy9JLE1BdFhYIiwiZmlsZSI6IjQtb3JnYW5pc21zL3ZpZGVvcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImZ1bmN0aW9uIG9uWW91VHViZUlmcmFtZUFQSVJlYWR5KCkge1xuICBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwuSW5pdGlhbGl6ZVZpZXdNb2RlbCgpO1xufVxuXG4oZnVuY3Rpb24gKCQsIERydXBhbCkge1xuICBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwgPSB7XG4gICAgYXR0YWNoOiBmdW5jdGlvbiBhdHRhY2goY29udGV4dCwgc2V0dGluZ3MpIHtcbiAgICAgICQoJy5qcy12aWRlby1tb2RhbCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgRHJ1cGFsLmJlaGF2aW9ycy52aWRlb01vZGFsLm9wZW5WaWRlb01vZGFsKCQodGhpcykpO1xuICAgICAgfSk7XG4gICAgfSxcblxuICAgIHZpZXdNb2RlbDoge30sXG5cbiAgICBjbGlja2VkRWxlbWVudDoge30sXG5cbiAgICBvcGVuVmlkZW9Nb2RhbDogZnVuY3Rpb24gKGVsKSB7XG4gICAgICBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwuY2xpY2tlZEVsZW1lbnQgPSBlbDtcblxuICAgICAgaWYgKHR5cGVvZiBZVCA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAkLmdldFNjcmlwdCgnLy93d3cueW91dHViZS5jb20vcGxheWVyX2FwaScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgRHJ1cGFsLmJlaGF2aW9ycy52aWRlb01vZGFsLkluaXRpYWxpemVWaWV3TW9kZWwoKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgSW5pdGlhbGl6ZVZpZXdNb2RlbDogZnVuY3Rpb24gKCkge1xuICAgICAgRHJ1cGFsLmJlaGF2aW9ycy52aWRlb01vZGFsLmNsaWNrZWRFbGVtZW50Lm9wZW5Nb2RhbCh7XG4gICAgICAgIHRlbXBsYXRlSWQ6ICd2aWRlby10ZW1wbGF0ZScsXG4gICAgICAgIHdpZHRoOiAnYXV0bydcbiAgICAgIH0pO1xuXG4gICAgICB2YXIgdmlkZW9JZCA9IERydXBhbC5iZWhhdmlvcnMudmlkZW9Nb2RhbC5jbGlja2VkRWxlbWVudC5kYXRhKFwidmlkZW9pZFwiKTtcbiAgICAgIHZhciB0cmFja2luZ0VuYWJsZWQgPSBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwuY2xpY2tlZEVsZW1lbnQuZGF0YShcInZpZGVvdHJhY2tpbmdcIikgJiYgRHJ1cGFsLmJlaGF2aW9ycy52aWRlb01vZGFsLmNsaWNrZWRFbGVtZW50LmRhdGEoXCJ2aWRlb3RyYWNraW5nXCIpID09PSB0cnVlO1xuXG4gICAgICBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwudmlld01vZGVsID0gbmV3IERydXBhbC5iZWhhdmlvcnMudmlkZW9Nb2RhbC52aWRlb1ZpZXdNb2RlbCh2aWRlb0lkLCB0cmFja2luZ0VuYWJsZWQpO1xuXG4gICAgICB2YXIga29FbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWwtdmlkZW8nKTtcbiAgICAgIGtvLmNsZWFuTm9kZShrb0VsZSk7XG4gICAgICBrby5hcHBseUJpbmRpbmdzKERydXBhbC5iZWhhdmlvcnMudmlkZW9Nb2RhbC52aWV3TW9kZWwsIGtvRWxlKTtcbiAgICAgICQoJy52aWRlby1ob2xkZXInKS5maXRWaWRzKCk7XG4gICAgfSxcblxuICAgIHZpZGVvVmlld01vZGVsOiBmdW5jdGlvbiAodmlkZW9JZCwgdHJhY2tpbmdFbmFibGVkKSB7XG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICBzZWxmLmludGVydmFsSWQgPSBudWxsO1xuICAgICAgc2VsZi5UcmFja2luZ0VuYWJsZWQgPSBrby5vYnNlcnZhYmxlKHRyYWNraW5nRW5hYmxlZCk7XG4gICAgICBzZWxmLlZpZGVvSWQgPSBrby5vYnNlcnZhYmxlKHZpZGVvSWQpO1xuICAgICAgc2VsZi5WaWRlb1RpdGxlID0ga28ub2JzZXJ2YWJsZSgpO1xuICAgICAgc2VsZi5WaWRlb0xpbmsgPSBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBcImh0dHA6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1cIiArIHNlbGYuVmlkZW9JZCgpO1xuICAgICAgfSk7XG5cbiAgICAgIHNlbGYuUGxheWVyID0gbmV3IFlULlBsYXllcigndmlkZW8taWZyYW1lJywge1xuICAgICAgICBwbGF5ZXJWYXJzOiB7IGF1dG9wbGF5OiAxLCBjb250cm9sczogMCwgc2hvd2luZm86IDEsIHJlbDogMCwgbW9kZXN0YnJhbmRpbmc6IDEgfSxcbiAgICAgICAgdmlkZW9JZDogdmlkZW9JZCxcbiAgICAgICAgZXZlbnRzOiB7XG4gICAgICAgICAgJ29uUmVhZHknOiBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwuUGxheWVyUmVhZHksXG4gICAgICAgICAgJ29uU3RhdGVDaGFuZ2UnOiBEcnVwYWwuYmVoYXZpb3JzLnZpZGVvTW9kYWwuUGxheWVyU3RhdGVDaGFuZ2VcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHNlbGYuUGxheWVyU3RhdGUgPSBrby5vYnNlcnZhYmxlKCk7XG5cbiAgICAgIHNlbGYuRm9ybWF0TnVtYmVyTGVuZ3RoID0gZnVuY3Rpb24gKG51bSwgbGVuZ3RoKSB7XG4gICAgICAgIHZhciByID0gXCJcIiArIG51bTtcbiAgICAgICAgd2hpbGUgKHIubGVuZ3RoIDwgbGVuZ3RoKSB7XG4gICAgICAgICAgciA9IFwiMFwiICsgcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcjtcbiAgICAgIH07XG5cbiAgICAgIHNlbGYuQ29udmVydFNlY29uZHNUb1RpbWVTdGFtcCA9IGZ1bmN0aW9uIChzZWNvbmRzKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygc2Vjb25kcyA9PT0gJ3VuZGVmaW5lZCcgfHwgc2Vjb25kcyA8IDEpIHtcbiAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBtaW51dGVzID0gTWF0aC5mbG9vcihzZWNvbmRzIC8gNjApO1xuICAgICAgICB2YXIgbGVmdFNlY29uZHMgPSAoc2Vjb25kcyAtIG1pbnV0ZXMgKiA2MCkudG9GaXhlZCgwKTtcbiAgICAgICAgbGVmdFNlY29uZHMgPSBzZWxmLkZvcm1hdE51bWJlckxlbmd0aChsZWZ0U2Vjb25kcywgMik7XG5cbiAgICAgICAgcmV0dXJuIG1pbnV0ZXMgKyBcIjpcIiArIGxlZnRTZWNvbmRzO1xuICAgICAgfTtcblxuICAgICAgc2VsZi5Ub3RhbExlbmd0aCA9IGtvLm9ic2VydmFibGUoMCk7XG5cbiAgICAgIHNlbGYuVG90YWxMZW5ndGhMYWJlbCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuQ29udmVydFNlY29uZHNUb1RpbWVTdGFtcChzZWxmLlRvdGFsTGVuZ3RoKCkpO1xuICAgICAgfSwgc2VsZik7XG5cbiAgICAgIHNlbGYuQ3VycmVudFRpbWUgPSBrby5vYnNlcnZhYmxlKDApO1xuXG4gICAgICBzZWxmLkN1cnJlbnRUaW1lTGFiZWwgPSBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBzZWxmLkNvbnZlcnRTZWNvbmRzVG9UaW1lU3RhbXAoc2VsZi5DdXJyZW50VGltZSgpKTtcbiAgICAgIH0sIHNlbGYpO1xuXG4gICAgICBzZWxmLlByb2dyZXNzUGVyY2VudCA9IGZ1bmN0aW9uIChjdXJyZW50LCB0b3RhbCkge1xuICAgICAgICB2YXIgcGVyY2VudCA9IDA7XG5cbiAgICAgICAgaWYgKGN1cnJlbnQgPT0gMCB8fCB0b3RhbCA9PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHBlcmNlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY3VycmVudCA+PSB0b3RhbCkge1xuICAgICAgICAgIHBlcmNlbnQgPSAxMDA7XG4gICAgICAgICAgcmV0dXJuIHBlcmNlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBwZXJjZW50ID0gY3VycmVudCAvIHRvdGFsICogMTAwO1xuXG4gICAgICAgIHJldHVybiBwZXJjZW50O1xuICAgICAgfTtcblxuICAgICAgc2VsZi5DdXJyZW50VGltZVByb2dyZXNzU3R5bGUgPSBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBzdHlsZSA9IFwid2lkdGg6XCIgKyBzZWxmLlByb2dyZXNzUGVyY2VudChzZWxmLkN1cnJlbnRUaW1lKCksIHNlbGYuVG90YWxMZW5ndGgoKSkgKyBcIiU7XCI7XG4gICAgICAgIHJldHVybiBzdHlsZTtcbiAgICAgIH0sIHNlbGYpO1xuXG4gICAgICBzZWxmLklzUGxheWluZyA9IGtvLm9ic2VydmFibGUoIXNlbGYuaXNUb3VjaERldmljZSk7XG5cbiAgICAgIHNlbGYuUGF1c2VDbGFzcyA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuSXNQbGF5aW5nKCkgPyBcInBhdXNlXCIgOiBcIlwiO1xuICAgICAgfSwgc2VsZik7XG5cbiAgICAgIHNlbGYuVHJpZ2dlclBsYXlQYXVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHNlbGYuSXNQbGF5aW5nKCkpIHtcbiAgICAgICAgICBzZWxmLlBsYXllci5wYXVzZVZpZGVvKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VsZi5QbGF5ZXIucGxheVZpZGVvKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHNlbGYuVHJpZ2dlclBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoc2VsZi5Jc1BsYXlpbmcoKSkge1xuICAgICAgICAgIHNlbGYuUGxheWVyLnBhdXNlVmlkZW8oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfTtcblxuICAgICAgLy8gUHJvZ3Jlc3NcbiAgICAgIHNlbGYuSXNQcm9ncmVzc0RyYWcgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcblxuICAgICAgc2VsZi5UcmlnZ2VyUHJvZ3Jlc3MgPSBmdW5jdGlvbiAoZGF0YSwgZSkge1xuICAgICAgICB2YXIgcG9zaXRpb24gPSBlLnBhZ2VYLFxuICAgICAgICAgIHRvdWNoO1xuXG4gICAgICAgIGlmIChzZWxmLmlzVG91Y2hEZXZpY2UpIHtcbiAgICAgICAgICBpZiAoZS5vcmlnaW5hbEV2ZW50LnRhcmdldFRvdWNoZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdG91Y2ggPSBlLm9yaWdpbmFsRXZlbnQudG91Y2hlc1swXSB8fCBlLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF07XG4gICAgICAgICAgICBwb3NpdGlvbiA9IHRvdWNoLnBhZ2VYO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgc2VsZi5Jc1Byb2dyZXNzRHJhZyh0cnVlKTtcbiAgICAgICAgc2VsZi5VcGRhdGVQcm9ncmVzcyhwb3NpdGlvbik7XG4gICAgICB9XG5cbiAgICAgIHNlbGYuVXBkYXRlUHJvZ3Jlc3MgPSBmdW5jdGlvbiAoeFBvc2l0aW9uKSB7XG4gICAgICAgIHZhciB2aWRlb1Byb2dyZXNzVG90YWwgPSAkKCcjdmlkZW8tcHJvZ3Jlc3MtdG90YWwnKSxcbiAgICAgICAgICBwb3NpdGlvbiA9IHhQb3NpdGlvbiAtIHZpZGVvUHJvZ3Jlc3NUb3RhbC5vZmZzZXQoKS5sZWZ0LFxuICAgICAgICAgIHBlcmNlbnRhZ2UgPSAxMDAgKiAocG9zaXRpb24gLyB2aWRlb1Byb2dyZXNzVG90YWwud2lkdGgoKSk7XG5cbiAgICAgICAgaWYgKHBlcmNlbnRhZ2UgPiAxMDApIHtcbiAgICAgICAgICBwZXJjZW50YWdlID0gMTAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBlcmNlbnRhZ2UgPCAwKSB7XG4gICAgICAgICAgcGVyY2VudGFnZSA9IDA7XG4gICAgICAgIH1cblxuICAgICAgICBzZWxmLlBsYXllci5zZWVrVG8oc2VsZi5Ub3RhbExlbmd0aCgpICogcGVyY2VudGFnZSAvIDEwMCk7XG4gICAgICB9O1xuXG4gICAgICBzZWxmLkJpbmRQcm9ncmVzc0V2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJChkb2N1bWVudCkub24oJ21vdXNldXAnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgIGlmIChzZWxmLklzUHJvZ3Jlc3NEcmFnKCkpIHtcbiAgICAgICAgICAgIHNlbGYuSXNQcm9ncmVzc0RyYWcoZmFsc2UpO1xuICAgICAgICAgICAgc2VsZi5VcGRhdGVQcm9ncmVzcyhlLnBhZ2VYKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgIGlmIChzZWxmLklzUHJvZ3Jlc3NEcmFnKCkpIHtcbiAgICAgICAgICAgIHNlbGYuVXBkYXRlUHJvZ3Jlc3MoZS5wYWdlWCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVm9sdW1lXG4gICAgICBzZWxmLklzVm9sdW1lRHJhZyA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuXG4gICAgICBzZWxmLlRyaWdnZXJWb2x1bWUgPSBmdW5jdGlvbiAoZGF0YSwgZSkge1xuICAgICAgICB2YXIgcG9zaXRpb24gPSBlLnBhZ2VYLFxuICAgICAgICAgIHRvdWNoO1xuXG5cbiAgICAgICAgaWYgKHNlbGYuaXNUb3VjaERldmljZSkge1xuICAgICAgICAgIGlmIChlLm9yaWdpbmFsRXZlbnQudGFyZ2V0VG91Y2hlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0b3VjaCA9IGUub3JpZ2luYWxFdmVudC50b3VjaGVzWzBdIHx8IGUub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgICAgICAgIHBvc2l0aW9uID0gdG91Y2gucGFnZVg7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzZWxmLklzVm9sdW1lRHJhZyh0cnVlKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzZWxmLlVwZGF0ZVZvbHVtZShwb3NpdGlvbik7XG4gICAgICB9O1xuXG4gICAgICBzZWxmLlVwZGF0ZVZvbHVtZSA9IGZ1bmN0aW9uICh4UG9zaXRpb24pIHtcbiAgICAgICAgdmFyIHZpZGVvVm9sdW1lVG90YWwgPSAkKCcjdmlkZW8tdm9sdW1lLXRvdGFsJyksXG4gICAgICAgICAgdmlkZW9Wb2x1bWVDdXJyZW50ID0gJCgnI3ZpZGVvLXZvbHVtZS1jdXJyZW50JyksXG4gICAgICAgICAgcG9zaXRpb24gPSB4UG9zaXRpb24gLSB2aWRlb1ZvbHVtZVRvdGFsLm9mZnNldCgpLmxlZnQsXG4gICAgICAgICAgcGVyY2VudGFnZSA9IDEwMCAqIChwb3NpdGlvbiAvIHZpZGVvVm9sdW1lVG90YWwud2lkdGgoKSk7XG5cbiAgICAgICAgaWYgKHBlcmNlbnRhZ2UgPiAxMDApIHtcbiAgICAgICAgICBwZXJjZW50YWdlID0gMTAwO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwZXJjZW50YWdlIDwgMCkge1xuICAgICAgICAgIHBlcmNlbnRhZ2UgPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgdmlkZW9Wb2x1bWVDdXJyZW50LmNzcygnd2lkdGgnLCAocGVyY2VudGFnZSArICclJykpO1xuICAgICAgICBzZWxmLlBsYXllci5zZXRWb2x1bWUocGVyY2VudGFnZSk7XG4gICAgICB9XG5cbiAgICAgIHNlbGYuQmluZFZvbHVtZUV2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJChkb2N1bWVudCkub24oJ21vdXNldXAnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgIGlmIChzZWxmLklzVm9sdW1lRHJhZygpKSB7XG4gICAgICAgICAgICBzZWxmLklzVm9sdW1lRHJhZyhmYWxzZSk7XG4gICAgICAgICAgICBzZWxmLlVwZGF0ZVZvbHVtZShlLnBhZ2VYKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgIGlmIChzZWxmLklzVm9sdW1lRHJhZygpKSB7XG4gICAgICAgICAgICBzZWxmLlVwZGF0ZVZvbHVtZShlLnBhZ2VYKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBGdWxsc2NyZWVuXG4gICAgICBzZWxmLklzRnVsbFNjcmVlbiA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICAgICAgc2VsZi5GdWxsU2NyZWVuQ2xhc3MgPSBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBzZWxmLklzRnVsbFNjcmVlbigpID8gJ2lzLWZ1bGxzY3JlZW4nIDogJyc7XG4gICAgICB9KTtcblxuICAgICAgc2VsZi5UcmlnZ2VyRnVsbFNjcmVlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgc2VsZi5Jc0Z1bGxTY3JlZW4oIXNlbGYuSXNGdWxsU2NyZWVuKCkpO1xuICAgICAgfTtcblxuICAgICAgLy8gU3RhdGVcbiAgICAgIHNlbGYuUGxheWVyU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICAgICAgc2VsZi5QbGF5ZXJTdGF0ZShzdGF0ZSk7XG5cbiAgICAgICAgaWYgKHN0YXRlLmRhdGEgPT0gWVQuUGxheWVyU3RhdGUuUExBWUlORyAmJiAhc2VsZi5Jc1BsYXlpbmcoKSkge1xuICAgICAgICAgIHNlbGYuSXNQbGF5aW5nKHRydWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHN0YXRlLmRhdGEgPT0gWVQuUGxheWVyU3RhdGUuUEFVU0VEICYmIHNlbGYuSXNQbGF5aW5nKCkpIHtcbiAgICAgICAgICBzZWxmLklzUGxheWluZyhmYWxzZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc3RhdGUuZGF0YSA9PSBZVC5QbGF5ZXJTdGF0ZS5FTkRFRCkge1xuICAgICAgICAgIHNlbGYuSXNQbGF5aW5nKGZhbHNlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZWxmLlRyYWNraW5nRW5hYmxlZCgpID09PSB0cnVlKSB7XG4gICAgICAgICAgc2VsZi5HQVRyYWNraW5nKHN0YXRlLmRhdGEpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBzZWxmLlBsYXllclJlYWR5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBzZWxmLlRvdGFsTGVuZ3RoKHNlbGYuUGxheWVyLmdldER1cmF0aW9uKCkpO1xuICAgICAgICBzZWxmLlZpZGVvVGl0bGUoc2VsZi5QbGF5ZXIuZ2V0VmlkZW9EYXRhKCkudGl0bGUpO1xuICAgICAgICBzZWxmLlBsYXllci5zZXRWb2x1bWUoODApO1xuICAgICAgICBzZWxmLlN0YXJ0SW50ZXJ2YWwoKTtcbiAgICAgICAgc2VsZi5CaW5kVm9sdW1lRXZlbnRzKCk7XG4gICAgICAgIHNlbGYuQmluZFByb2dyZXNzRXZlbnRzKCk7XG4gICAgICB9O1xuXG4gICAgICBzZWxmLlVwZGF0ZUludGVydmFsID0ga28ub2JzZXJ2YWJsZSgpO1xuXG4gICAgICBzZWxmLlN0YXJ0SW50ZXJ2YWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNlbGYuVXBkYXRlSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChzZWxmLlVwZGF0ZVVJLCAxMDApO1xuICAgICAgfTtcblxuICAgICAgc2VsZi5TdG9wSW50ZXJ2YWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNsZWFySW50ZXJ2YWwoc2VsZi5VcGRhdGVJbnRlcnZhbCk7XG4gICAgICB9O1xuXG4gICAgICBzZWxmLlVwZGF0ZVVJID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBzZWxmLkN1cnJlbnRUaW1lKHNlbGYuUGxheWVyLmdldEN1cnJlbnRUaW1lKCkpO1xuXG4gICAgICAgIGlmIChzZWxmLlRvdGFsTGVuZ3RoKCkgPT0gMCkge1xuICAgICAgICAgIHNlbGYuVG90YWxMZW5ndGgoc2VsZi5QbGF5ZXIuZ2V0RHVyYXRpb24oKSk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAvLyAtLS0tLS0tICAgR0EgdHJhY2tpbmcgIC0tLS0tLS0tLS0tLS0tLVxuICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgICAgc2VsZi5HQVRyYWNraW5nID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgICAgIHZhciBrZXkgPSBzZWxmLlZpZGVvSWQoKTtcbiAgICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICAgIGNhc2UgWVQuUGxheWVyU3RhdGUuUExBWUlORzpcbiAgICAgICAgICAgIGdhKCdzZW5kJywgJ2V2ZW50Jywga2V5ICsgJyAtIHZpZGVvJywgJ1N0YXJ0ZWQnLCBrZXkgKyAnIC0gdmlkZW8gdHJhY2tpbmcnKTtcbiAgICAgICAgICAgIGRhdGFMYXllci5wdXNoKHsnZXZlbnQnOiAnc3RhcnRlZCd9KTtcbiAgICAgICAgICAgIHNlbGYuR0FTdGFydFBsYXlUcmFja2luZyhrZXkpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBZVC5QbGF5ZXJTdGF0ZS5FTkRFRDpcbiAgICAgICAgICAgIHNlbGYuR0FTdG9wUGxheVRyYWNraW5nKCk7XG4gICAgICAgICAgICBnYSgnc2VuZCcsICdldmVudCcsIGtleSArICcgLSB2aWRlbycsICdDb21wbGV0ZWQnLCBrZXkgKyAnIC0gdmlkZW8gdHJhY2tpbmcnKTtcbiAgICAgICAgICAgIGRhdGFMYXllci5wdXNoKHsnZXZlbnQnOiAnY29tcGxldGVkJ30pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHNlbGYuR0FTdGFydFBsYXlUcmFja2luZyA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgc2VsZi5HQVN0b3BQbGF5VHJhY2tpbmcoKTtcblxuICAgICAgICB2YXIgaW50ZXJ2YWxUaW1lID0gNSxcbiAgICAgICAgICBpbnRlcnZhbENvdW50ID0gNCxcbiAgICAgICAgICBpbnRlcnZhbFJhdGlvID0gMSAvIDQsXG4gICAgICAgICAgaW50ZXJ2YWxNYXJrZXJzID0gW2ludGVydmFsQ291bnRdLFxuICAgICAgICAgIGR1cmF0aW9uID0gc2VsZi5QbGF5ZXIuZ2V0RHVyYXRpb24oKTtcblxuICAgICAgICBpbnRlcnZhbE1hcmtlcnNbMF0gPSAwO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgaW50ZXJ2YWxDb3VudDsgaSsrKSB7XG4gICAgICAgICAgaW50ZXJ2YWxNYXJrZXJzW2ldID0gaSAqIGludGVydmFsUmF0aW8gKiBkdXJhdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIHNlbGYuaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2YXIgdGltZSA9IHNlbGYuUGxheWVyLmdldEN1cnJlbnRUaW1lKCk7XG5cbiAgICAgICAgICAkLmVhY2goaW50ZXJ2YWxNYXJrZXJzLCBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmICgoKGl0ZW0gLSB0aW1lKSA8IGludGVydmFsVGltZSkgJiYgKGl0ZW0gLSB0aW1lKSA+IDApIHtcbiAgICAgICAgICAgICAgdmFyIHBlcmNlbnQgPSBpbnRlcnZhbFJhdGlvICogaW5kZXggKiAxMDAgKyAnJScsXG4gICAgICAgICAgICAgICAgcGVyY2VudE51bSA9IGludGVydmFsUmF0aW8gKiBpbmRleCAqIDEwMDtcbiAgICAgICAgICAgICAgZ2EoJ3NlbmQnLCAnZXZlbnQnLCBrZXkgKyAnIC0gdmlkZW8nLCAnV2F0Y2hlZCAnICsgcGVyY2VudCwga2V5ICsgJyAtIHZpZGVvIHRyYWNraW5nJyk7XG4gICAgICAgICAgICAgIGRhdGFMYXllci5wdXNoKHsnZXZlbnQnOiAnd2F0Y2hlZCcgKyBwZXJjZW50TnVtfSk7XG4gICAgICAgICAgICAgIGludGVydmFsTWFya2Vyc1tpbmRleF0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0sIGludGVydmFsVGltZSAqIDEwMDApO1xuICAgICAgfTtcblxuICAgICAgc2VsZi5HQVN0b3BQbGF5VHJhY2tpbmcgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChzZWxmLmludGVydmFsSWQgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY2xlYXJJbnRlcnZhbChzZWxmLmludGVydmFsSWQpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgcmV0dXJuIHNlbGY7XG4gICAgfSxcblxuICAgIGlzVG91Y2hEZXZpY2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiAoKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdylcbiAgICAgICAgfHwgKG5hdmlnYXRvci5NYXhUb3VjaFBvaW50cyA+IDApXG4gICAgICAgIHx8IChuYXZpZ2F0b3IubXNNYXhUb3VjaFBvaW50cyA+IDApKTtcbiAgICB9LFxuXG4gICAgUGxheWVyUmVhZHk6IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIERydXBhbC5iZWhhdmlvcnMudmlkZW9Nb2RhbC52aWV3TW9kZWwuUGxheWVyUmVhZHkoKTtcbiAgICB9LFxuXG4gICAgUGxheWVyU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgICAgRHJ1cGFsLmJlaGF2aW9ycy52aWRlb01vZGFsLnZpZXdNb2RlbC5QbGF5ZXJTdGF0ZUNoYW5nZShzdGF0ZSk7XG4gICAgfVxuXG4gIH07XG59KShqUXVlcnksIERydXBhbCk7XG4iXX0=
